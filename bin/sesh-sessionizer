#!/usr/bin/env bash

IFS=':' read -ra directories <<<"$SESH_DIRECTORIES"

clone_mode() {
  platform=$(
    printf "GitHub (nrk)\nGitHub (stianlj)\nGitLab (local)" | fzf \
      --header $'Keybindings:\n  Enter: Select platform\n  Ctrl-c/Esc: Cancel' \
      --prompt='ğŸŒ Platform: ' \
      --height=40% \
      --reverse \
      --border
  )

  if [ $? -ne 0 ]; then
    exit 0
  fi

  fzf_filter_repo() {
    fzf \
      --header $'Keybindings:\n  Enter: Select repo\n  Ctrl-c/Esc: Cancel' \
      --prompt='ğŸ” ' \
      --height=50% \
      --reverse \
      --border \
      --ansi
  }

  case $platform in
    "GitHub (private)")
      repo=$(
        gh search repos \
          --json fullName \
          --jq '.[].fullName' \
          --owner stianlj \
          --sort updated \
          --limit 1000 |
          fzf_filter_repo
      )
      clone_cmd=(gh repo clone)
      ;;
    "GitHub (nrk)")
      repo=$(
        gh search repos \
          --json fullName \
          --jq '.[].fullName' \
          --owner nrkno \
          --sort updated \
          --limit 1000 \
          -- 'dh-' |
          fzf_filter_repo
      )
      clone_cmd=(gh repo clone)
      ;;
    "GitLab (local)")
      repo=$(
        glab repo list -F json |
          jq -r .[].path_with_namespace |
          fzf_filter_repo
      )
      clone_cmd=(glab repo clone)
      ;;
    *)
      echo "Invalid platform selected."
      exit 1
      ;;
  esac

  if [ "$repo" = "" ]; then
    exit 0
  fi

  base_folder=$(
    printf '%s\n' "${directories[@]}" | fzf \
      --header 'Select destination folder:' \
      --prompt='ğŸ“ ' \
      --height=40% \
      --reverse \
      --border
  )

  if [ $? -ne 0 ]; then
    exit 0
  fi

  repo_folder="$base_folder/$(basename "$repo")"

  if [ -d "$repo_folder" ]; then
    session="$repo_folder"
  else
    echo "Cloning $repo to $repo_folder..."
    "${clone_cmd[@]}" "$repo" "$repo_folder"
    session="$repo_folder"
  fi
}

main_mode() {
  if [ "$1" != "" ]; then
    session=$1
  else
    all_dirs=$(
      find "${directories[@]}" -mindepth 1 -maxdepth 1 -not -path '*/.*' -type d,l |
        sed 's/^/ğŸ“ /'
    )

    active_sessions=$(sesh list -t -i)

    fzf_cmd=(fzf
      --bind "ctrl-g:execute($0 --clone)+abort"
      --header $'Keybindings:\n  Enter: Select session/dir\n  Ctrl-g: Clone new repo\n  Ctrl-c/Esc: Cancel'
      --header-lines=0
      --prompt='âš¡ '
      --reverse
      --border
      --ansi
    )

    if [[ "$NO_PREVIEW" != true ]]; then
      fzf_cmd+=(--preview='sesh preview {}')
    fi

    session=$(
      printf "%s\n%s\n" "$active_sessions" "$all_dirs" | "${fzf_cmd[@]}"
    )

    if [ $? -ne 0 ]; then
      exit 0
    fi
  fi
}

is_kitty() {
  [[ "$TERM" == "xterm-kitty" ]]
}

CLONE_MODE=false
NO_PREVIEW=false
SESSION_ARG=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --clone | -c)
      CLONE_MODE=true
      shift
      ;;
    --no-preview | -n)
      NO_PREVIEW=true
      shift
      ;;
    --help | -h)
      echo "Usage: $0 [OPTIONS] [SESSION]"
      echo ""
      echo "Options:"
      echo "  --clone, -c          Enter clone mode to add new repositories"
      echo "  --no-preview, -n     Disable fzf preview in session selector"
      echo "  --help, -h           Show this help message"
      exit 0
      ;;
    -*)
      echo "Error: Unknown option: $1" >&2
      echo "Use --help for usage information" >&2
      exit 1
      ;;
    *)
      SESSION_ARG="$1"
      shift
      ;;
  esac
done

if [[ "$CLONE_MODE" == true ]]; then
  clone_mode
else
  main_mode "$SESSION_ARG"
fi

session="${session#ğŸ“ }"
session_name=$(basename "$session")

is_kitty && kitten @ set-spacing padding=0
sesh connect "$session"
is_kitty && kitten @ set-spacing padding=default
